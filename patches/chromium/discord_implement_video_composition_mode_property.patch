From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mack Straight <mack@discordapp.com>
Date: Sat, 13 Mar 2021 13:01:55 -0800
Subject: implement video composition mode property


diff --git a/content/renderer/media/media_factory.cc b/content/renderer/media/media_factory.cc
index a973c8d22e48cfbb24c7052429c0f5314f7eb609..bb55abb7c7d9209b7b0a65ab2e352b6ddda5295d 100644
--- a/content/renderer/media/media_factory.cc
+++ b/content/renderer/media/media_factory.cc
@@ -59,6 +59,7 @@
 #include "third_party/blink/public/platform/media/web_media_player_impl.h"
 #include "third_party/blink/public/platform/media/web_media_player_params.h"
 #include "third_party/blink/public/platform/platform.h"
+#include "third_party/blink/public/platform/web_media_player_client.h"
 #include "third_party/blink/public/platform/web_surface_layer_bridge.h"
 #include "third_party/blink/public/platform/web_video_frame_submitter.h"
 #include "third_party/blink/public/web/blink.h"
@@ -794,8 +795,14 @@ blink::WebMediaPlayer* MediaFactory::CreateWebMediaPlayerForMediaStream(
       render_frame_->GetTaskRunner(blink::TaskType::kInternalMedia),
       std::move(handlers));
 
-  const auto surface_layer_mode =
+  auto surface_layer_mode =
       GetSurfaceLayerMode(MediaPlayerType::kMediaStream);
+
+  blink::WebMediaPlayer::SurfaceLayerMode layer_mode_override;
+  if (client->DesiredSurfaceLayerMode(&layer_mode_override)) {
+    surface_layer_mode = layer_mode_override;
+  }
+
   std::unique_ptr<blink::WebVideoFrameSubmitter> submitter = CreateSubmitter(
       main_thread_compositor_task_runner, &video_frame_compositor_task_runner,
       settings, media_log.get(), render_frame_, surface_layer_mode);
diff --git a/third_party/blink/public/mojom/use_counter/css_property_id.mojom b/third_party/blink/public/mojom/use_counter/css_property_id.mojom
index 6a2786b10c8cc550132ebd5d3f3df95192aaa9a8..c38a4c63f15309e316b4478184eed760dab9e378 100644
--- a/third_party/blink/public/mojom/use_counter/css_property_id.mojom
+++ b/third_party/blink/public/mojom/use_counter/css_property_id.mojom
@@ -42,6 +42,7 @@ enum CSSSampleId {
     kInternalForcedColor = 0,
     kInternalForcedOutlineColor = 0,
     kInternalForcedVisitedColor = 0,
+    kDiscordVideoComposition = 0,
 
     // This CSSSampleId represents page load for CSS histograms. It is recorded once
     // per page visit for each CSS histogram being logged on the blink side and the
diff --git a/third_party/blink/public/platform/web_media_player_client.h b/third_party/blink/public/platform/web_media_player_client.h
index f95f5f6bc8ee45317801206a71ed14f4657893a7..83a6300724a39512f1c1395096404adb4ecca1e8 100644
--- a/third_party/blink/public/platform/web_media_player_client.h
+++ b/third_party/blink/public/platform/web_media_player_client.h
@@ -228,6 +228,11 @@ class BLINK_PLATFORM_EXPORT WebMediaPlayerClient {
   // learning experiment.
   virtual Features GetFeatures() = 0;
 
+  // Desired surface layer mode. Returns false if no preference.
+  virtual bool DesiredSurfaceLayerMode(WebMediaPlayer::SurfaceLayerMode*) {
+    return false;
+  }
+
  protected:
   ~WebMediaPlayerClient() = default;
 };
diff --git a/third_party/blink/renderer/core/css/css_properties.json5 b/third_party/blink/renderer/core/css/css_properties.json5
index 9db9496073b072a4a72be4121208a30989598b60..377e10dbaa5b09a1cf5c28e5e4649f7ce636778c 100644
--- a/third_party/blink/renderer/core/css/css_properties.json5
+++ b/third_party/blink/renderer/core/css/css_properties.json5
@@ -6828,6 +6828,16 @@
       converter: "ConvertInternalAlignSelfBlock",
     },
 
+    {
+      name: "-discord-video-composition",
+      property_methods: ["CSSValueFromComputedStyleInternal"],
+      field_group: "*",
+      field_template: "keyword",
+      keywords: ["surface-layer", "video-layer"],
+      typedom_types: ["Keyword"],
+      default_value: "surface-layer",
+    },
+
     // Aliases; these map to the same CSSPropertyID
     {
       name: "-epub-caption-side",
diff --git a/third_party/blink/renderer/core/css/css_value_keywords.json5 b/third_party/blink/renderer/core/css/css_value_keywords.json5
index 615e8545c231505ee1f67fdcfcaa1752296f0435..c0fb56ab301581796c9ce616320c7a2ce0cbe8e9 100644
--- a/third_party/blink/renderer/core/css/css_value_keywords.json5
+++ b/third_party/blink/renderer/core/css/css_value_keywords.json5
@@ -1462,6 +1462,10 @@
     "numbers",
     "words",
 
+    // -discord-video-composition
+    "surface-layer",
+    "video-layer",
+
     // ([video]-dynamic-range) media feature
     "standard",
     "high",
diff --git a/third_party/blink/renderer/core/css/parser/css_parser_fast_paths.cc b/third_party/blink/renderer/core/css/parser/css_parser_fast_paths.cc
index bfb7316a7cb8f1c0ee25da578743a7976bdbfb12..b32c8eb67dcfb95822809c3bb9c48189634f4f65 100644
--- a/third_party/blink/renderer/core/css/parser/css_parser_fast_paths.cc
+++ b/third_party/blink/renderer/core/css/parser/css_parser_fast_paths.cc
@@ -1009,6 +1009,9 @@ bool CSSParserFastPaths::IsValidKeywordPropertyAndValue(
              value_id == CSSValueID::kContain || value_id == CSSValueID::kNone;
     case CSSPropertyID::kOriginTrialTestProperty:
       return value_id == CSSValueID::kNormal || value_id == CSSValueID::kNone;
+    case CSSPropertyID::kDiscordVideoComposition:
+      return value_id == CSSValueID::kSurfaceLayer ||
+             value_id == CSSValueID::kVideoLayer;
     default:
       NOTREACHED();
       return false;
@@ -1129,6 +1132,7 @@ bool CSSParserFastPaths::IsKeywordPropertyID(CSSPropertyID property_id) {
     case CSSPropertyID::kScrollbarWidth:
     case CSSPropertyID::kScrollSnapStop:
     case CSSPropertyID::kOriginTrialTestProperty:
+    case CSSPropertyID::kDiscordVideoComposition:
       return true;
     default:
       return false;
diff --git a/third_party/blink/renderer/core/css/properties/longhands/longhands_custom.cc b/third_party/blink/renderer/core/css/properties/longhands/longhands_custom.cc
index 9a398f47b480c0446dd2be136ff93044acdf7443..5e00499373c43db88e92548f39e14691361e57b0 100644
--- a/third_party/blink/renderer/core/css/properties/longhands/longhands_custom.cc
+++ b/third_party/blink/renderer/core/css/properties/longhands/longhands_custom.cc
@@ -8856,5 +8856,12 @@ const CSSValue* InternalEmptyLineHeight::ParseSingleValue(
                                          CSSValueID::kNone>(range);
 }
 
+const CSSValue* DiscordVideoComposition::CSSValueFromComputedStyleInternal(
+    const ComputedStyle& style,
+    const LayoutObject*,
+    bool allow_visited_style) const {
+  return CSSIdentifierValue::Create(style.DiscordVideoComposition());
+}
+
 }  // namespace css_longhand
 }  // namespace blink
diff --git a/third_party/blink/renderer/core/html/media/html_media_element.cc b/third_party/blink/renderer/core/html/media/html_media_element.cc
index 8a9a66f0c3c27ca5e4ac1b1b60980cea6b1e4a44..90bf1698438f2d1ab5e2fd97bc2bf80b393207e4 100644
--- a/third_party/blink/renderer/core/html/media/html_media_element.cc
+++ b/third_party/blink/renderer/core/html/media/html_media_element.cc
@@ -67,6 +67,7 @@
 #include "third_party/blink/renderer/core/dom/element_traversal.h"
 #include "third_party/blink/renderer/core/dom/events/event.h"
 #include "third_party/blink/renderer/core/dom/events/event_queue.h"
+#include "third_party/blink/renderer/core/dom/node_computed_style.h"
 #include "third_party/blink/renderer/core/dom/shadow_root.h"
 #include "third_party/blink/renderer/core/events/keyboard_event.h"
 #include "third_party/blink/renderer/core/fileapi/url_file_api.h"
@@ -862,6 +863,44 @@ void HTMLMediaElement::AttachLayoutTree(AttachContext& context) {
 void HTMLMediaElement::DidRecalcStyle(const StyleRecalcChange change) {
   if (!change.ReattachLayoutTree())
     UpdateLayoutObject();
+  UpdateDiscordVideoComposition();
+}
+
+void HTMLMediaElement::UpdateDiscordVideoComposition() {
+  absl::optional<EDiscordVideoComposition> video_composition;
+  auto* style = GetComputedStyle();
+
+  if (style) {
+    video_composition = style->DiscordVideoComposition();
+  }
+
+  if (video_composition != last_video_composition_) {
+    last_video_composition_ = video_composition;
+
+    // The way MediaFactory and WebMediaPlayerMS and its related classes
+    // interact to handle layer setup and threading is amazingly hairy and
+    // profoundly misdesigned, so just reload the player completely if we switch
+    // compositing modes. Fixing this would require changing all the plumbing so
+    // WebMediaPlayerMS can switch modes freely even if it was initialized in
+    // surface layer mode.
+    ignore_preload_none_ = false;
+    InvokeLoadAlgorithm();
+  }
+}
+
+bool HTMLMediaElement::DesiredSurfaceLayerMode(
+    WebMediaPlayer::SurfaceLayerMode* desired_mode) {
+  DCHECK(IsMainThread());
+
+  if (!last_video_composition_.has_value()) {
+    return false;
+  }
+
+  *desired_mode =
+      *last_video_composition_ == EDiscordVideoComposition::kSurfaceLayer
+          ? WebMediaPlayer::SurfaceLayerMode::kAlways
+          : WebMediaPlayer::SurfaceLayerMode::kNever;
+  return true;
 }
 
 void HTMLMediaElement::ScheduleTextTrackResourceLoad() {
diff --git a/third_party/blink/renderer/core/html/media/html_media_element.h b/third_party/blink/renderer/core/html/media/html_media_element.h
index 9dc3406443dc6655050d66defe733a8ba2785302..8e6484a28940f21973ee1ce785b3157124def59b 100644
--- a/third_party/blink/renderer/core/html/media/html_media_element.h
+++ b/third_party/blink/renderer/core/html/media/html_media_element.h
@@ -457,6 +457,8 @@ class CORE_EXPORT HTMLMediaElement
 
   bool IsInteractiveContent() const final;
 
+  void UpdateDiscordVideoComposition();
+
   // ExecutionContextLifecycleStateObserver functions.
   void ContextLifecycleStateChanged(mojom::FrameLifecycleState) override;
   void ContextDestroyed() override;
@@ -548,6 +550,8 @@ class CORE_EXPORT HTMLMediaElement
   void SetPowerExperimentState(bool enabled) override;
   void SetAudioSinkId(const String&) override;
   void SuspendForFrameClosed() override;
+  bool DesiredSurfaceLayerMode(
+      WebMediaPlayer::SurfaceLayerMode* desired_mode) override;
 
   void LoadTimerFired(TimerBase*);
   void ProgressEventTimerFired();
@@ -753,6 +757,8 @@ class CORE_EXPORT HTMLMediaElement
   scoped_refptr<MediaSourceAttachment> media_source_attachment_;
   Member<MediaSourceTracer> media_source_tracer_;
 
+  absl::optional<EDiscordVideoComposition> last_video_composition_;
+
   // Stores "official playback position", updated periodically from "current
   // playback position". Official playback position should not change while
   // scripts are running. See setOfficialPlaybackPosition().
