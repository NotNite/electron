name: Build for moonlight

on:
  workflow_dispatch:
    inputs:
      build-image-sha:
        type: string
        description: "SHA for electron/build image"
        default: "77262e58c37631ab082482f42c33cdf68c6c394b"
        required: true

jobs:
  checkout-linux:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/electron/build:${{ inputs.build-image-sha }}
      options: --user root
      volumes:
        - /mnt/cross-instance-cache:/mnt/cross-instance-cache
        - /var/run/sas:/var/run/sas
    env:
      GCLIENT_EXTRA_ARGS: "--custom-var=checkout_arm=True --custom-var=checkout_arm64=True"
    steps:
      - name: Checkout Electron
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332
        with:
          path: src/electron
          fetch-depth: 0
      - name: Checkout & Sync & Save
        uses: ./src/electron/.github/actions/checkout

  linux-x64:
    permissions:
      contents: read
      issues: read
      pull-requests: read
    uses: ./.github/workflows/pipeline-segment-electron-build.yml
    needs: checkout-linux
    with:
      target-platform: linux
      target-arch: x64
      build-runs-on: ubuntu-latest
      build-container: '{"image":"ghcr.io/electron/build:${{ inputs.build-image-sha }}","options":"--user root","volumes":["/mnt/cross-instance-cache:/mnt/cross-instance-cache"]}'
      is-release: true
      gn-build-type: release
      generate-symbols: true
      upload-to-storage: "0"
